{{- /* layouts/partials/comments.html */ -}}

{{/* ----- Bloco de Variáveis para Depuração e Condicional ----- */}}
{{ $showComments := false }}
{{ $debugOutput := slice }}

{{ $globalCommentsEnabled := .Site.Params.comments }}
{{ $pageType := .Type }}
{{ $mainSections := .Site.Params.mainSections }}
{{ $pageCommentsParam := .Params.comments }}

{{ $pageCommentsNotDisabled := ne $pageCommentsParam false }}

{{ $isTypePosts := eq $pageType "posts" }}
{{ $isTypeBlog := eq $pageType "blog" }}
{{ $isInMainSections := false }}
{{ if $mainSections }}{{ $isInMainSections = in $mainSections $pageType }}{{ end }}
{{ $typeConditionMet := or $isInMainSections $isTypePosts $isTypeBlog }}

{{ $finalCondition := and $globalCommentsEnabled $typeConditionMet $pageCommentsNotDisabled }}
{{ $showComments = $finalCondition }}

{{ $debugOutput = $debugOutput | append (printf "Site.Params.comments (Global): [%v]" $globalCommentsEnabled) }}
{{ $debugOutput = $debugOutput | append (printf "Page.Type (Tipo da página atual): [%s]" $pageType) }}
{{ $debugOutput = $debugOutput | append (printf "Site.Params.mainSections: [%s]" (delimit .Site.Params.mainSections ",")) }}
{{ $debugOutput = $debugOutput | append (printf "Page.Params.comments (Front matter): [%v]" $pageCommentsParam) }}
{{ $debugOutput = $debugOutput | append (printf "Condição (Page.Params.comments NÃO é false): [%v]" $pageCommentsNotDisabled) }}
{{ $debugOutput = $debugOutput | append (printf "Condição (Page.Type é 'posts'): [%v]" $isTypePosts) }}
{{ $debugOutput = $debugOutput | append (printf "Condição (Page.Type é 'blog'): [%v]" $isTypeBlog) }}
{{ $debugOutput = $debugOutput | append (printf "Condição (Page.Type está em Site.Params.mainSections): [%v]" $isInMainSections) }}
{{ $debugOutput = $debugOutput | append (printf "Condição de Tipo Combinada (mainSections OU 'posts' OU 'blog') é: [%v]" $typeConditionMet) }}
{{ $debugOutput = $debugOutput | append (printf "RESULTADO FINAL DA CONDICIONAL 'and' SERÁ: [%v]" $finalCondition) }}
{{/* ----- Fim do Bloco de Variáveis ----- */}}

{{/* ----- INÍCIO DAS LINHAS DE DEPURAÇÃO TEMPORÁRIAS (VISÍVEIS NO HTML GERADO) ----- */}}
{{/* ----- FIM DAS LINHAS DE DEPURAÇÃO TEMPORÁRIAS ----- */}}


{{/* Condicional Principal usa a variável $showComments definida acima */}}
{{ if $showComments }}
    {{ if .Site.Params.giscus.repo }}
        <div class="comments giscus" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
            <h3>{{ .Site.Params.giscus.title | default "Comentários" }}</h3>
            <script src="https://giscus.app/client.js"
                    data-repo="{{ .Site.Params.giscus.repo }}"
                    data-repo-id="{{ .Site.Params.giscus.repoId }}"
                    data-category="{{ .Site.Params.giscus.category }}"
                    data-category-id="{{ .Site.Params.giscus.categoryId }}"
                    data-mapping="{{ .Site.Params.giscus.mapping | default "pathname" }}"
                    data-strict="{{ .Site.Params.giscus.strict | default "0" }}"
                    data-reactions-enabled="{{ .Site.Params.giscus.reactionsEnabled | default "1" }}"
                    data-emit-metadata="{{ .Site.Params.giscus.emitMetadata | default "0" }}"
                    data-input-position="{{ .Site.Params.giscus.inputPosition | default "bottom" }}"
                    data-theme="{{ .Site.Params.giscus.theme | default "preferred_color_scheme" }}"
                    data-lang="{{ .Site.Params.giscus.lang | default "pt" }}"
                    data-loading="{{ .Site.Params.giscus.loading | default "lazy" }}"
                    crossorigin="anonymous"
                    async>
            </script>
            <noscript>Por favor, habilite o JavaScript para ver os <a href="https://giscus.app">comentários do Giscus.</a></noscript>
            <p style="font-size: 0.9rem; margin-top: 1rem;">
                <a href="https://github.com/{{ .Site.Params.giscus.repo }}/discussions" target="_blank" rel="noopener noreferrer">
                    Ver discussões no GitHub
                </a>
            </p>
        </div>
    {{ else }}
        <p>A configuração de comentários (Giscus) está ausente no arquivo de configuração do site (hugo.toml).</p>
    {{ end }}
{{ else }}
    {{ end }}